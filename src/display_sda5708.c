#include <avr/io.h>
#include <avr/pgmspace.h>

#include "data_types.h"

#define MAX_CHAR_BYTES  (7u)

/** Table containing bitmasks for supported ASCII characters */
static const u8 char_table[][MAX_CHAR_BYTES] PROGMEM =
{
    { 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u }, /* Space */
    { 0x04u, 0x04u, 0x04u, 0x04u, 0x04u, 0x00u, 0x04u }, /* ! */
    { 0x0Au, 0x0Au, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u }, /* " */
    { 0x0Au, 0x0Au, 0x1Fu, 0x0Au, 0x1Fu, 0x0Au, 0x0Au }, /* # */
    { 0x04u, 0x0Fu, 0x14u, 0x0Eu, 0x05u, 0x1Eu, 0x04u }, /* $ */
    { 0x18u, 0x19u, 0x02u, 0x04u, 0x08u, 0x13u, 0x03u }, /* % */
    { 0x00u, 0x08u, 0x14u, 0x08u, 0x15u, 0x12u, 0x0Du }, /* & */
    { 0x04u, 0x04u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u }, /* ' */
    { 0x02u, 0x04u, 0x08u, 0x08u, 0x08u, 0x04u, 0x02u }, /* ( */
    { 0x08u, 0x04u, 0x02u, 0x02u, 0x02u, 0x04u, 0x08u }, /* ) */
    { 0x00u, 0x15u, 0x0Eu, 0x04u, 0x0Eu, 0x15u, 0x00u }, /* * */
    { 0x00u, 0x04u, 0x04u, 0x1Fu, 0x04u, 0x04u, 0x00u }, /* + */
    { 0x00u, 0x00u, 0x00u, 0x00u, 0x0Cu, 0x04u, 0x08u }, /* , */
    { 0x00u, 0x00u, 0x00u, 0x1Fu, 0x00u, 0x00u, 0x00u }, /* - */
    { 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x0Cu, 0x0Cu }, /* . */
    { 0x00u, 0x01u, 0x02u, 0x04u, 0x08u, 0x10u, 0x00u }, /* / */
    { 0x04u, 0x0Au, 0x11u, 0x11u, 0x11u, 0x0Au, 0x04u }, /* 0 */
    { 0x04u, 0x0Cu, 0x04u, 0x04u, 0x04u, 0x04u, 0x0Eu }, /* 1 */
    { 0x0Eu, 0x11u, 0x02u, 0x04u, 0x08u, 0x10u, 0x1Fu }, /* 2 */
    { 0x1Fu, 0x01u, 0x02u, 0x06u, 0x01u, 0x11u, 0x0Eu }, /* 3 */
    { 0x02u, 0x06u, 0x0Au, 0x12u, 0x1Fu, 0x02u, 0x02u }, /* 4 */
    { 0x1Fu, 0x10u, 0x10u, 0x1Eu, 0x01u, 0x11u, 0x0Eu }, /* 5 */
    { 0x0Fu, 0x10u, 0x10u, 0x1Eu, 0x11u, 0x11u, 0x0Eu }, /* 6 */
    { 0x1Fu, 0x01u, 0x02u, 0x04u, 0x04u, 0x04u, 0x04u }, /* 7 */
    { 0x0Eu, 0x11u, 0x11u, 0x0Eu, 0x11u, 0x11u, 0x0Eu }, /* 8 */
    { 0x0Eu, 0x11u, 0x11u, 0x0Fu, 0x01u, 0x01u, 0x1Eu }, /* 9 */
    { 0x00u, 0x0Cu, 0x0Cu, 0x00u, 0x0Cu, 0x0Cu, 0x00u }, /* : */
    { 0x00u, 0x0Cu, 0x0Cu, 0x00u, 0x0Cu, 0x04u, 0x08u }, /* ; */
    { 0x02u, 0x04u, 0x08u, 0x10u, 0x08u, 0x04u, 0x02u }, /* < */
    { 0x00u, 0x00u, 0x1Fu, 0x00u, 0x1Fu, 0x00u, 0x00u }, /* = */
    { 0x08u, 0x04u, 0x02u, 0x01u, 0x02u, 0x04u, 0x08u }, /* > */
    { 0x0Eu, 0x11u, 0x02u, 0x04u, 0x04u, 0x00u, 0x04u }, /* ? */
    { 0x0Eu, 0x11u, 0x15u, 0x17u, 0x10u, 0x11u, 0x0Eu }, /* @ */
    { 0x04u, 0x0Au, 0x11u, 0x1Fu, 0x11u, 0x11u, 0x11u }, /* A */
    { 0x1Eu, 0x09u, 0x09u, 0x0Eu, 0x09u, 0x09u, 0x1Eu }, /* B */
    { 0x0Eu, 0x11u, 0x10u, 0x10u, 0x10u, 0x11u, 0x0Eu }, /* C */
    { 0x1Eu, 0x09u, 0x09u, 0x09u, 0x09u, 0x09u, 0x1Eu }, /* D */
    { 0x1Fu, 0x10u, 0x10u, 0x1Cu, 0x10u, 0x10u, 0x1Fu }, /* E */
    { 0x1Fu, 0x10u, 0x10u, 0x1Cu, 0x10u, 0x10u, 0x10u }, /* F */
    { 0x0Fu, 0x10u, 0x10u, 0x10u, 0x17u, 0x11u, 0x0Eu }, /* G */
    { 0x11u, 0x11u, 0x11u, 0x1Fu, 0x11u, 0x11u, 0x11u }, /* H */
    { 0x0Eu, 0x04u, 0x04u, 0x04u, 0x04u, 0x04u, 0x0Eu }, /* I */
    { 0x0Eu, 0x04u, 0x04u, 0x04u, 0x04u, 0x14u, 0x08u }, /* J */
    { 0x11u, 0x12u, 0x14u, 0x18u, 0x14u, 0x12u, 0x11u }, /* K */
    { 0x10u, 0x10u, 0x10u, 0x10u, 0x10u, 0x10u, 0x1Fu }, /* L */
    { 0x11u, 0x1Bu, 0x15u, 0x15u, 0x11u, 0x11u, 0x11u }, /* M */
    { 0x11u, 0x11u, 0x19u, 0x15u, 0x13u, 0x11u, 0x11u }, /* N */
    { 0x0Eu, 0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x0Eu }, /* O */
    { 0x1Eu, 0x11u, 0x11u, 0x1Eu, 0x10u, 0x10u, 0x10u }, /* P */
    { 0x0Eu, 0x11u, 0x11u, 0x11u, 0x15u, 0x12u, 0x0Du }, /* Q */
    { 0x1Eu, 0x11u, 0x11u, 0x1Eu, 0x14u, 0x12u, 0x11u }, /* R */
    { 0x0Eu, 0x11u, 0x10u, 0x0Eu, 0x01u, 0x11u, 0x0Eu }, /* S */
    { 0x1Fu, 0x04u, 0x04u, 0x04u, 0x04u, 0x04u, 0x04u }, /* T */
    { 0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x0Eu }, /* U */
    { 0x11u, 0x11u, 0x11u, 0x11u, 0x0Au, 0x0Au, 0x04u }, /* V */
    { 0x11u, 0x11u, 0x11u, 0x11u, 0x15u, 0x15u, 0x0Au }, /* W */
    { 0x11u, 0x11u, 0x0Au, 0x04u, 0x0Au, 0x11u, 0x11u }, /* X */
    { 0x11u, 0x11u, 0x0Au, 0x0Au, 0x04u, 0x04u, 0x04u }, /* Y */
    { 0x1Fu, 0x01u, 0x02u, 0x04u, 0x08u, 0x10u, 0x1Fu }, /* Z */
    { 0x0Fu, 0x08u, 0x08u, 0x08u, 0x08u, 0x08u, 0x0Fu }, /* [ */
    { 0x00u, 0x10u, 0x08u, 0x04u, 0x02u, 0x01u, 0x00u }, /* \ */
    { 0x1Eu, 0x02u, 0x02u, 0x02u, 0x02u, 0x02u, 0x1Eu }, /* ] */
    { 0x04u, 0x0Au, 0x11u, 0x00u, 0x00u, 0x00u, 0x00u }, /* ^ */
    { 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x1Fu }, /* _ */
    { 0x04u, 0x08u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u }, /* ' */
    { 0x00u, 0x0Eu, 0x01u, 0x0Du, 0x13u, 0x11u, 0x0Fu }, /* a */
    { 0x10u, 0x10u, 0x10u, 0x16u, 0x19u, 0x11u, 0x1Eu }, /* b */
    { 0x00u, 0x00u, 0x0Fu, 0x10u, 0x10u, 0x10u, 0x0Fu }, /* c */
    { 0x01u, 0x01u, 0x01u, 0x0Du, 0x13u, 0x11u, 0x0Fu }, /* d */
    { 0x00u, 0x00u, 0x0Eu, 0x11u, 0x1Eu, 0x10u, 0x0Eu }, /* e */
    { 0x06u, 0x09u, 0x08u, 0x1Cu, 0x08u, 0x08u, 0x08u }, /* f */
    { 0x00u, 0x0Fu, 0x11u, 0x13u, 0x0Du, 0x01u, 0x0Eu }, /* g */
    { 0x10u, 0x10u, 0x10u, 0x16u, 0x19u, 0x11u, 0x11u }, /* h */
    { 0x00u, 0x04u, 0x00u, 0x04u, 0x04u, 0x04u, 0x04u }, /* i */
    { 0x00u, 0x02u, 0x00u, 0x02u, 0x02u, 0x12u, 0x0Cu }, /* j */
    { 0x10u, 0x10u, 0x11u, 0x12u, 0x1Cu, 0x12u, 0x11u }, /* k */
    { 0x0Cu, 0x04u, 0x04u, 0x04u, 0x04u, 0x04u, 0x0Eu }, /* l */
    { 0x00u, 0x00u, 0x1Au, 0x15u, 0x15u, 0x15u, 0x15u }, /* m */
    { 0x00u, 0x00u, 0x16u, 0x19u, 0x11u, 0x11u, 0x11u }, /* n */
    { 0x00u, 0x00u, 0x0Eu, 0x11u, 0x11u, 0x11u, 0x0Eu }, /* o */
    { 0x00u, 0x1Eu, 0x11u, 0x19u, 0x16u, 0x10u, 0x10u }, /* p */
    { 0x00u, 0x0Fu, 0x11u, 0x13u, 0x0Du, 0x01u, 0x01u }, /* q */
    { 0x00u, 0x00u, 0x16u, 0x19u, 0x10u, 0x10u, 0x10u }, /* r */
    { 0x00u, 0x00u, 0x0Fu, 0x10u, 0x0Eu, 0x01u, 0x1Eu }, /* s */
    { 0x04u, 0x04u, 0x0Eu, 0x04u, 0x04u, 0x05u, 0x02u }, /* t */
    { 0x00u, 0x00u, 0x11u, 0x11u, 0x11u, 0x13u, 0x0Du }, /* u */
    { 0x00u, 0x00u, 0x11u, 0x11u, 0x11u, 0x0Au, 0x04u }, /* v */
    { 0x00u, 0x00u, 0x11u, 0x11u, 0x15u, 0x15u, 0x0Au }, /* w */
    { 0x00u, 0x00u, 0x11u, 0x0Au, 0x04u, 0x0Au, 0x11u }, /* x */
    { 0x00u, 0x00u, 0x11u, 0x11u, 0x0Fu, 0x02u, 0x0Cu }, /* y */
    { 0x00u, 0x00u, 0x1Fu, 0x02u, 0x04u, 0x08u, 0x1Fu }, /* z */
    { 0x03u, 0x04u, 0x04u, 0x08u, 0x04u, 0x04u, 0x03u }, /* { */
    { 0x04u, 0x04u, 0x04u, 0x00u, 0x04u, 0x04u, 0x04u }, /* | */
    { 0x18u, 0x04u, 0x04u, 0x02u, 0x04u, 0x04u, 0x18u }, /* } */
    { 0x08u, 0x15u, 0x02u, 0x00u, 0x00u, 0x00u, 0x00u }, /* ~ */
    { 0x1Fu, 0x1Fu, 0x1Fu, 0x1Fu, 0x1Fu, 0x1Fu, 0x1Fu }  /* sqaure */
};

#ifdef GPIO_INIT
#error Already defined.
#else
#define GPIO_INIT   (0u)
#endif

#ifdef GPIO_SET
#error Already defined.
#else
#define GPIO_SET    (1u)
#endif

#ifdef GPIO_RESET
#error Already defined.
#else
#define GPIO_RESET  (2u)
#endif

#ifdef LOAD
#error Already defined.
#else
#define LOAD    (0u)
#endif

#ifdef CLOCK
#error Already defined.
#else
#define CLOCK   (1u)
#endif

#ifdef RESET
#error Already defined.
#else
#define RESET   (2u)
#endif

#ifdef DATA
#error Already defined.
#else
#define DATA    (3u)
#endif

/**
 * @brief Performs a GPIO operation
 * @param[in] operation Operation to perform
 * @param[in] gpio_type GPIO
 */
static void gpio_operation(const u8 operation, const u8 gpio_type)
{
    switch (operation)
    {
        case GPIO_INIT:
            {
                /* Set GPIO as outputs */
                DDRB |= (u8)(_BV(PB0));
                DDRB |= (u8)(_BV(PB1));
                DDRB |= (u8)(_BV(PB2));
                DDRB |= (u8)(_BV(PB3));
                break;
            }

        case GPIO_SET:
            {
                switch (gpio_type)
                {
                    case LOAD:
                        {
                            PORTB |= (u8)(_BV(PB0));
                            break;
                        }
                    case DATA:
                        {
                            PORTB |= (u8)(_BV(PB1));
                            break;
                        }
                    case CLOCK:
                        {
                            PORTB |= (u8)(_BV(PB2));
                            break;
                        }
                    case RESET:
                        {
                            PORTB |= (u8)(_BV(PB3));
                            break;
                        }
                    default:
                        {
                            break;
                        }
                }
                break;
            }

        case GPIO_RESET:
            {
                switch (gpio_type)
                {
                    case LOAD:
                        {
                            PORTB &= (u8)(~_BV(PB0));
                            break;
                        }
                    case DATA:
                        {
                            PORTB &= (u8)(~_BV(PB1));
                            break;
                        }
                    case CLOCK:
                        {
                            PORTB &= (u8)(~_BV(PB2));
                            break;
                        }
                    case RESET:
                        {
                            PORTB &= (u8)(~_BV(PB3));
                            break;
                        }
                    default:
                        {
                            break;
                        }
                }
                break;
            }

        default:
            {
                break;
            }
    }

    return;
}

/**
 * @brief Prints input string to the display.
 * @param[in] p_data Pointer to the string
 */
static void write(const u8 data)
{
    u8 mask = 0x01u;
    u8 i = 0u;

    gpio_operation(GPIO_RESET, LOAD);
    gpio_operation(GPIO_RESET, DATA);
    gpio_operation(GPIO_RESET, CLOCK);

    for (i = 0u; i < 8u; ++i)
    {
        /* Set data */
        if (0u == (data & mask))
        {
            gpio_operation(GPIO_RESET, DATA);
        }
        else
        {
            gpio_operation(GPIO_SET, DATA);
        }

        /* Generate one clock pulse */
        gpio_operation(GPIO_RESET, CLOCK);
        gpio_operation(GPIO_SET, CLOCK);
        gpio_operation(GPIO_RESET, CLOCK);

        mask <<= 1u;
    }

    gpio_operation(GPIO_SET, LOAD);
    gpio_operation(GPIO_RESET, DATA);
    gpio_operation(GPIO_RESET, CLOCK);

    return;
}

/**
 * @brief Prints matrix bits of one character to the display
 * @param[in] ascii_code ASCII code of the character matrix bits
 * @see char_table
 */
static void printf_char(const u8 ascii_code)
{
    u8 n = ascii_code;
    u8 k = 0u;
    u8 data = 0u;

    if (n < 32u)
    {
        for (k = 0u; k < MAX_CHAR_BYTES; ++k)
        {
            data = pgm_read_byte_near(&(char_table[0u][k]));
            write(data);
        }
    }
    else
    {
        n -= 32u;

        for (k = 0u; k < MAX_CHAR_BYTES; ++k)
        {
            data = pgm_read_byte_near(&(char_table[n][k]));
            write(data);
        }
    }
}

/**
 * @brief Performs display initialization
 */
void display_sda5708_init(void)
{
    /* Set up GPIOs */
    gpio_operation(GPIO_INIT, 0u);
    gpio_operation(GPIO_SET, RESET);
    gpio_operation(GPIO_SET, LOAD);
    gpio_operation(GPIO_RESET, DATA);
    gpio_operation(GPIO_RESET, CLOCK);

    /* Clear the display */
    write(0xC1u);

    /* Set normal operation */
    write(0xE1u);

    return;
}

/**
 * @brief Prints input string to the display.
 * @param[in] p_data Pointer to the string
 */
void display_sda5708_printf(const char p_data[])
{
    u8 i = 0u;
    u8 cnt = 0u;
    u8 ascii_code = 0;

    /* This loop prints all 8 characters of the display */
    for (i = 0u; i < 8u; ++i)
    {
        /* Set character address register */
        write(0xA0u | i);

        /* Write column data */
        if (0 == p_data[cnt])
        {
            /* End of string reached, print space character */
            printf_char(32u);
        }
        else
        {
            ascii_code = (u8)(p_data[cnt]);
            ++cnt;
            printf_char(ascii_code);
        }
    }

    return;
}

